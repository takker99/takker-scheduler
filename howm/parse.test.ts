/// <reference lib="deno.ns" />

import { Event, makeRepeat, parse, toString } from "./parse.ts";
import { assertEquals, assertSnapshot } from "../deps/testing.ts";
import { toDate } from "./localDate.ts";

const runTests = async (t: Deno.TestContext, args: string[]) => {
  for (const arg of args) {
    await t.step(arg, () => assertSnapshot(t, parse(arg)));
  }
};

Deno.test("parse()", async (t) => {
  await t.step("compatibility", (t) =>
    runTests(t, [
      "â¬œã‚¿ã‚¹ã‚¯ãƒªãƒ³ã‚¯+@2023-09-10",
      "âœ…çµ‚äº†ã—ãŸãƒªãƒ³ã‚¯+@2023-09-10",
      "âŒå¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ã‚‚çµ‚äº†æ‰±ã„ã¨ã™ã‚‹+@2023-09-10",
      "ğŸ“ã‚„ã‚Šé€”ä¸­ã®+@2023-09-10ãƒªãƒ³ã‚¯",
      "å…ˆé ­ã«ãªã„çµµæ–‡å­—ã¯âœ…ã‚¿ã‚¹ã‚¯åˆ¤å®šã¨é–¢ä¿‚ãªã„+@2023-09-10",
      "âœ…æ—¥ä»˜ãŒãªã„ã‚¿ã‚¹ã‚¯ã¯ã‚¿ã‚¹ã‚¯ã¨ã¿ãªã•ãªã„",
    ]));
  {
    const arg = " å‰å¾Œã® ç©ºç™½ã¯ã€€+@2023-09-11 ç„¡è¦–ã•ã‚Œã‚‹ã€€  ";
    await t.step(arg, () => assertSnapshot(t, parse(arg)));
  }
  await t.step("type", (t) =>
    runTests(t, [
      "!@2002-10-20 ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ ã€†åˆ‡",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ ã€†åˆ‡!4@2002-10-20",
      "-@2002-10-20 ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ+@2002-10-20 è²·ãŠã†",
      "æŒ‡å®šå­ãªã—ã¯Eventã¨ã—ã¦æ‰±ã†@2023-04-11T13:00/14:00",
    ]));
  await t.step("start datetime", (t) =>
    runTests(t, [
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-30",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04â€»ã‚¿ã‚¹ã‚¯æ‰±ã„ã•ã‚Œãªã„",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023â€»ã‚¿ã‚¹ã‚¯æ‰±ã„ã•ã‚Œãªã„",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-30T12:23",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-30T12:23:45 â€»ç§’ã¯ç„¡è¦–ã™ã‚‹",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-30 12:23:â€»åŒºåˆ‡ã‚Šæ–‡å­—ãŒå¿…è¦",
    ]));
  await t.step("end datetime", (t) =>
    runTests(t, [
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/05-23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/2024-05-23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/2024-05-23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/05-23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13/05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/05-23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/2025-05-23D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/2025-05-23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/05-23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/23T05:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/T05:47D45â€»çµ‚äº†æ™‚åˆ»ã®ã¿ã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯Tã‚’ã¤ã‘ãªã„",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/14:47D45",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13T13:40/14:47",
      "ã”ã¯ã‚“ã‚’é£Ÿã¹ã‚‹+3@2023-04-13D45/05:47",
    ]));
  await t.step("errors", (t) =>
    runTests(t, [
      "+3@2023-04-30/23D45 çµ‚äº†æ—¥æ™‚ãŒé–‹å§‹æ—¥æ™‚ã‚ˆã‚Šæ—©ã¾ã£ã¦ã¯ãªã‚‰ãªã„",
      "ä¸æ­£ãªæ—¥æ™‚ã‚’ä¸ãˆã‚‹ã¨Invalid Dateã«ãªã‚‹+3@2023-04-33/05-23D45",
      "ä¸æ­£ãªæ—¥æ™‚+3@2023-04-13T13:40/05:67D45",
    ]));
  await t.step("taskãŒãªã„ã¨ãã¯çµ‚äº†æ™‚åˆ»ã¾ã§æ˜è¨˜ã™ã‚‹", (t) =>
    runTests(t, [
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª@2023-09-12T12:50D10",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª@2023-09-12T12:50/14:20",
      "çµ‚äº†æ™‚åˆ»ãŒãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹@2023-09-12T12:50",
      "é–‹å§‹æ™‚åˆ»ãŒãªã„ã®ã§ã‚¨ãƒ©ãƒ¼@2023-09-12D10",
    ]));
  await t.step("taskã®æ—¥ä»˜æƒ…å ±ã‹ã‚‰ç¶™æ‰¿ã™ã‚‹", (t) =>
    runTests(t, [
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10@13",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12D10@13T12:50",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12@13T12:50D10",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12@13T12:50/14:20",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12@12-13T12:50D10",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12@2024-12-13T12:50D10",
      "æ™‚åˆ»ãŒãªã„~@2023-09-12@13",
      "çµ‚äº†æ™‚åˆ»ãŒãªã„~@2023-09-12@13T13:45",
      "é–‹å§‹æ™‚åˆ»ãŒãªã„~@2023-09-12@13D45",
      "@13é †åºã‚’é€†ã«ã™ã‚‹ã¨èªè­˜ã•ã‚Œãªã„~@2023-09-12T12:50D10",
    ]));
  await t.step("ç¹°ã‚Šè¿”ã—", (t) =>
    runTests(t, [
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10R4@13",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10R47@13",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10R",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10RM8",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10RY8",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10RW8",
      "ãƒã‚¤ã‚¦ã‚§ã‚¤æƒ‘æ˜Ÿ è²·ãŠã†ã‹ãª~@2023-09-12T12:50D10RD8",
      "èª­æ›¸ä¼š@2023-09-12T12:50D10RD8",
    ]));
});

Deno.test("makeRepeat()", () => {
  {
    const task = "ã²ã‚‹ã”ã¯ã‚“@2023-10-09T12:00D30R1";
    assertEquals(
      toString(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2023, month: 10, date: 10 }),
        )!,
      ),
      "@2023-10-10T12:00D30ã²ã‚‹ã”ã¯ã‚“",
    );
    assertEquals(
      toString(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2023, month: 11, date: 10 }),
        )!,
      ),
      "@2023-11-10T12:00D30ã²ã‚‹ã”ã¯ã‚“",
    );
    assertEquals(
      toString(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2024, month: 11, date: 10 }),
        )!,
      ),
      "@2024-11-10T12:00D30ã²ã‚‹ã”ã¯ã‚“",
    );
  }

  {
    const task = "çˆªåˆ‡ã‚Š@2023-10-09T12:00D5RW1";
    assertEquals(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2023, month: 10, date: 10 }),
        ),
        undefined,
    );
    assertEquals(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2023, month: 10, date: 15 }),
        ),
        undefined,
    );
    assertEquals(
      toString(
        makeRepeat(
          parse(task)!.value as unknown as Event,
          toDate({ year: 2023, month: 10, date: 16 }),
        )!,
      ),
      "@2023-10-16T12:00D5çˆªåˆ‡ã‚Š",
    );
  }
});
